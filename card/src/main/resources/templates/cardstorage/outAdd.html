<#bs4Body>
<div class="container-fluid">
    <div id="add-modal">
        <form id="save-form">
            <table id="add-table" class="table table-bordered">
                <tbody>
                <tr>
                    <td class="info-column-card-out">领取人</td>
                    <td class="info-cell-card-out">
                        <#bautoCompleteProvider
                        _hiddenDomainId="applyUserId"
                        _hiddenDomainName="applyUserId"
                        _displayDomainId="applyUserName"
                        _displayDomainName="applyUserName"
                        _placeholder=""
                        _optionVariable="userNameAutoCompleteOption"/>
                    </td>
                </tr>
                <tr>
                    <td class="info-column-card-out">工号</td>
                    <td id="_userCode" class="info-cell-card-out"></td>
                    <input id="userCode" name="applyUserCode" type="hidden" class="form-control"/>
                </tr>
                <tr>
                    <td class="info-column-card-out">已读数量</td>
                    <td>
                        <input id="amount" name="amount" type="text" class="form-control" readonly/>
                        <input id="cardNos" name="cardNos" type="hidden" class="form-control"/>
                    </td>
                    <td>
                        <button id="btn-out" type="button" class="btn btn-primary" onclick="readCard()">
                            开启读卡器
                        </button>
                    </td>
                    </td>
                </tr>
            </table>
        </form>
    </div>
</div>
</#bs4Body>
<script type="text/javascript" src="${contextPath}/resources/js/sword.js"></script>
<script type="text/javascript" src="${contextPath}/resources/js/jquery.validate.extend.js"></script>
<#common_autoCompleteUser/>
<#common_cardBaseJs/>
<script>
    let temp = {
        total: 0,
        cardNos: []
    };
    $(() =>{
        //修改一下“确定”按钮文本
        $.modal.changeEnsureTxt("出库")
    });

    let formId = "save-form";
    $("#" + formId).validate({
        onkeyup: false,
        rules: {
            applyUserName: {
                required: true,
            },
            amount: {
                required: true,
            }
        },
        messages: {
            applyUserName: {
                required: "领取人必填",
            },
            amount: {
                required: "出库数量必填",
            }
        },
        focusCleanup: true
    });

    function submitHandler(e) {
        if (!$.validate.form(formId)) {
            return false;
        }
        let url = "${contextPath}/cardStorage/addOut.action";
        let data = $.common.formToJSON(formId);
        //console.log(JSON.stringify(data))
        $.operate.post(url, data);
    }

    function readCard() {
        let cardNo = readerCardNumber();
        if ($.common.isEmpty(cardNo)){
            $.modal.alertWarning("请将卡片放置在读卡器上");
            return;
        }
        if(temp.cardNos.indexOf(cardNo) > -1){
            $.modal.alertWarning("该卡片已经在待出库序列中。。。");
            return;
        }
        let params = {
            cardNo: cardNo,
            checkCardActionType: 2
        };
        let config = {
            url: "${contextPath}/cardStorage/checkCard.action",
            type: 'get',
            data: params,
            success: (result) => {
                if (result.code != web_status.SUCCESS) {
                    $.modal.alertWarning(result.message)
                }else {
                    temp.total++;
                    temp.cardNos.push(cardNo);
                    $('#amount').val(temp.total);
                    $('#cardNos').val(temp.cardNos.join(","));
                }
            },
        };
        $.ajax(config);
    }
</script>
